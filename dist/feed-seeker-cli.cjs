#!/usr/bin/env node
"use strict";const _=require("commander"),p=require("linkedom"),r=require("./deepSearch-B6Nx8Ryc.cjs"),g=require("./eventEmitter-CvqYYQvu.cjs"),y=require("./checkFeed-CUSfVVkN.cjs"),w=require("module"),l=require("node:util");var a=typeof document<"u"?document.currentScript:null;class b extends g.EventEmitter{constructor(e,t={}){super(),e.includes("://")||(e=`https://${e}`);const i=new URL(e);this.site=i.pathname==="/"?i.origin:i.href,this.options=t,this.initPromise=null}async initialize(){return this.initPromise===null&&(this.initPromise=(async()=>{try{const e=await y.fetchWithTimeout(this.site,this.options.timeout*1e3);if(!e.ok){this.emit("error",{module:"FeedScout",error:`HTTP error while fetching ${this.site}: ${e.status} ${e.statusText}`}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized");return}this.content=await e.text();const{document:t}=p.parseHTML(this.content);this.document=t,this.emit("initialized")}catch(e){let t=`Failed to fetch ${this.site}`;e.name==="AbortError"?t+=": Request timed out":(t+=`: ${e.message}`,e.cause&&(t+=` (cause: ${e.cause.code||e.cause.message})`)),this.emit("error",{module:"FeedScout",error:t,cause:e.cause}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized")}})()),this.initPromise}async metaLinks(){return await this.initialize(),r.metaLinks(this)}async checkAllAnchors(){return await this.initialize(),r.checkAllAnchors(this)}async blindSearch(){return await this.initialize(),r.blindSearch(this)}async deepSearch(){return await this.initialize(),r.deepSearch(this.site,this.options,this)}async startSearch(){const{deepsearchOnly:e,metasearch:t,blindsearch:i,anchorsonly:h,deepsearch:d,all:o,maxFeeds:B}=this.options;if(e)return this.deepSearch();if(t)return this.metaLinks();if(i)return this.blindSearch();if(h)return this.checkAllAnchors();let x=[];const f=[this.metaLinks,this.checkAllAnchors,this.blindSearch];for(const s of f){const c=await s.call(this);if(c&&c.length>0&&(x=x.concat(c),!o&&B>0&&x.length>=B)){x=x.slice(0,B);break}}if(d&&(!B||x.length<B)){const s=await this.deepSearch();s&&s.length>0&&(x=x.concat(s),B>0&&x.length>B&&(x=x.slice(0,B)))}return this.emit("end",{module:"all",feeds:x}),x}}let u=0;function S(){console.log(` \x1B[38;2;255;17;0m_\x1B[0m\x1B[38;2;255;34;0m_\x1B[0m\x1B[38;2;255;51;0m_\x1B[0m\x1B[38;2;255;69;0m_\x1B[0m\x1B[38;2;255;86;0m_\x1B[0m             \x1B[38;2;130;255;0m_\x1B[0m \x1B[38;2;65;255;0m_\x1B[0m\x1B[38;2;32;255;0m_\x1B[0m\x1B[38;2;0;255;0m_\x1B[0m\x1B[38;2;0;220;34m_\x1B[0m                  \x1B[38;2;119;0;179m_\x1B[0m
\x1B[38;2;255;0;0m|\x1B[0m  \x1B[38;2;255;51;0m_\x1B[0m\x1B[38;2;255;69;0m_\x1B[0m\x1B[38;2;255;86;0m_\x1B[0m\x1B[38;2;255;103;0m|\x1B[0m\x1B[38;2;255;120;0m_\x1B[0m\x1B[38;2;255;137;0m_\x1B[0m  \x1B[38;2;255;186;0m_\x1B[0m\x1B[38;2;255;202;0m_\x1B[0m\x1B[38;2;255;219;0m_\x1B[0m  \x1B[38;2;228;255;0m_\x1B[0m\x1B[38;2;195;255;0m_\x1B[0m\x1B[38;2;163;255;0m|\x1B[0m \x1B[38;2;97;255;0m/\x1B[0m \x1B[38;2;32;255;0m_\x1B[0m\x1B[38;2;0;255;0m_\x1B[0m\x1B[38;2;0;220;34m_\x1B[0m\x1B[38;2;0;185;69m|\x1B[0m  \x1B[38;2;0;81;173m_\x1B[0m\x1B[38;2;0;47;207m_\x1B[0m\x1B[38;2;0;12;242m_\x1B[0m \x1B[38;2;15;0;228m_\x1B[0m\x1B[38;2;25;0;212m_\x1B[0m\x1B[38;2;34;0;196m_\x1B[0m  \x1B[38;2;63;0;148m_\x1B[0m   \x1B[38;2;101;0;159m_\x1B[0m\x1B[38;2;110;0;169m|\x1B[0m \x1B[38;2;129;0;190m|\x1B[0m\x1B[38;2;138;0;200m_\x1B[0m
\x1B[38;2;255;0;0m|\x1B[0m \x1B[38;2;255;34;0m|\x1B[0m\x1B[38;2;255;51;0m_\x1B[0m \x1B[38;2;255;86;0m/\x1B[0m \x1B[38;2;255;120;0m_\x1B[0m \x1B[38;2;255;153;0m\\\x1B[0m\x1B[38;2;255;170;0m/\x1B[0m \x1B[38;2;255;202;0m_\x1B[0m \x1B[38;2;255;235;0m\\\x1B[0m\x1B[38;2;255;252;0m/\x1B[0m \x1B[38;2;195;255;0m_\x1B[0m\x1B[38;2;163;255;0m\`\x1B[0m \x1B[38;2;97;255;0m\\\x1B[0m\x1B[38;2;65;255;0m_\x1B[0m\x1B[38;2;32;255;0m_\x1B[0m\x1B[38;2;0;255;0m_\x1B[0m \x1B[38;2;0;185;69m\\\x1B[0m \x1B[38;2;0;116;138m/\x1B[0m \x1B[38;2;0;47;207m_\x1B[0m\x1B[38;2;0;12;242m_\x1B[0m\x1B[38;2;6;0;244m/\x1B[0m \x1B[38;2;25;0;212m_\x1B[0m \x1B[38;2;44;0;180m\\\x1B[0m\x1B[38;2;54;0;164m|\x1B[0m \x1B[38;2;73;0;132m|\x1B[0m \x1B[38;2;91;0;148m|\x1B[0m \x1B[38;2;110;0;169m|\x1B[0m \x1B[38;2;129;0;190m_\x1B[0m\x1B[38;2;138;0;200m_\x1B[0m\x1B[38;2;148;0;211m|\x1B[0m
\x1B[38;2;255;0;0m|\x1B[0m  \x1B[38;2;255;51;0m_\x1B[0m\x1B[38;2;255;69;0m|\x1B[0m  \x1B[38;2;255;120;0m_\x1B[0m\x1B[38;2;255;137;0m_\x1B[0m\x1B[38;2;255;153;0m/\x1B[0m  \x1B[38;2;255;202;0m_\x1B[0m\x1B[38;2;255;219;0m_\x1B[0m\x1B[38;2;255;235;0m/\x1B[0m \x1B[38;2;228;255;0m(\x1B[0m\x1B[38;2;195;255;0m_\x1B[0m\x1B[38;2;163;255;0m|\x1B[0m \x1B[38;2;97;255;0m|\x1B[0m\x1B[38;2;65;255;0m_\x1B[0m\x1B[38;2;32;255;0m_\x1B[0m\x1B[38;2;0;255;0m_\x1B[0m\x1B[38;2;0;220;34m)\x1B[0m \x1B[38;2;0;151;103m|\x1B[0m \x1B[38;2;0;81;173m(\x1B[0m\x1B[38;2;0;47;207m_\x1B[0m\x1B[38;2;0;12;242m|\x1B[0m \x1B[38;2;15;0;228m(\x1B[0m\x1B[38;2;25;0;212m_\x1B[0m\x1B[38;2;34;0;196m)\x1B[0m \x1B[38;2;54;0;164m|\x1B[0m \x1B[38;2;73;0;132m|\x1B[0m\x1B[38;2;82;0;138m_\x1B[0m\x1B[38;2;91;0;148m|\x1B[0m \x1B[38;2;110;0;169m|\x1B[0m \x1B[38;2;129;0;190m|\x1B[0m\x1B[38;2;138;0;200m_\x1B[0m
\x1B[38;2;255;0;0m|\x1B[0m\x1B[38;2;255;17;0m_\x1B[0m\x1B[38;2;255;34;0m|\x1B[0m  \x1B[38;2;255;86;0m\\\x1B[0m\x1B[38;2;255;103;0m_\x1B[0m\x1B[38;2;255;120;0m_\x1B[0m\x1B[38;2;255;137;0m_\x1B[0m\x1B[38;2;255;153;0m|\x1B[0m\x1B[38;2;255;170;0m\\\x1B[0m\x1B[38;2;255;186;0m_\x1B[0m\x1B[38;2;255;202;0m_\x1B[0m\x1B[38;2;255;219;0m_\x1B[0m\x1B[38;2;255;235;0m|\x1B[0m\x1B[38;2;255;252;0m\\\x1B[0m\x1B[38;2;228;255;0m_\x1B[0m\x1B[38;2;195;255;0m_\x1B[0m\x1B[38;2;163;255;0m,\x1B[0m\x1B[38;2;130;255;0m_\x1B[0m\x1B[38;2;97;255;0m|\x1B[0m\x1B[38;2;65;255;0m_\x1B[0m\x1B[38;2;32;255;0m_\x1B[0m\x1B[38;2;0;255;0m_\x1B[0m\x1B[38;2;0;220;34m_\x1B[0m\x1B[38;2;0;185;69m/\x1B[0m \x1B[38;2;0;116;138m\\\x1B[0m\x1B[38;2;0;81;173m_\x1B[0m\x1B[38;2;0;47;207m_\x1B[0m\x1B[38;2;0;12;242m_\x1B[0m\x1B[38;2;6;0;244m\\\x1B[0m\x1B[38;2;15;0;228m_\x1B[0m\x1B[38;2;25;0;212m_\x1B[0m\x1B[38;2;34;0;196m_\x1B[0m\x1B[38;2;44;0;180m/\x1B[0m \x1B[38;2;63;0;148m\\\x1B[0m\x1B[38;2;73;0;132m_\x1B[0m\x1B[38;2;82;0;138m_\x1B[0m\x1B[38;2;91;0;148m,\x1B[0m\x1B[38;2;101;0;159m_\x1B[0m\x1B[38;2;110;0;169m|\x1B[0m\x1B[38;2;119;0;179m\\\x1B[0m\x1B[38;2;129;0;190m_\x1B[0m\x1B[38;2;138;0;200m_\x1B[0m\x1B[38;2;148;0;211m|\x1B[0m

     \x1B[1;31m---> On the trail of every feed <---\x1B[0m
`)}function k(m){process.stdout.write(`Starting ${m.niceName} `)}function F(m){m.feeds.length===0?process.stdout.write(l.styleText("yellow",` No feeds found.
`)):process.stdout.write(l.styleText("green",` Found ${m.feeds.length} feeds.
`))}async function $(m){if(m.module==="metalinks"&&process.stdout.write("."),m.module==="blindsearch"||m.module==="anchors"){process.stdout.write(`\x1B[${u}D`);const e=` (${m.totalCount}/${m.totalEndpoints})`;process.stdout.write(e),u=e.length}}function q(m,e){const t=new b(m,e);return t.site=m,t.options=e,t.on("start",k),t.on("log",$),t.on("end",F),t}async function A(m,e){m.includes("://")||(m=`https://${m}`);const t=q(m,e),i=[()=>t.metaLinks(),()=>t.checkAllAnchors(),()=>t.blindSearch()];return await(async()=>{for(const o of i){const B=await o();if(B.length>0)return B}return[]})()}S();const n=new _.Command;n.name("feed-scout").description("Find RSS, Atom, and JSON feeds on any website with FeedScout.");n.command("version").description("Get version").action(()=>{const e=w.createRequire(typeof document>"u"?require("url").pathToFileURL(__filename).href:a&&a.tagName.toUpperCase()==="SCRIPT"&&a.src||new URL("feed-seeker-cli.js",document.baseURI).href)("./package.json");process.stdout.write(`${e.version}
`)});n.argument("[site]","The website URL to search for feeds").option("-m, --metasearch","Meta search only").option("-b, --blindsearch","Blind search only").option("-a, --anchorsonly","Anchors search only").option("-d, --deepsearch","Enable deep search").option("--deepsearch-only","Deep search only").option("--depth <number>","Depth of deep search","3").option("--max-links <number>","Maximum number of links to process during deep search","1000").option("--timeout <seconds>","Timeout for fetch requests in seconds","5").option("--keep-query-params","Keep query parameters from the original URL when searching").option("--check-foreign-feeds","Check if foreign domain URLs are feeds (but don't crawl them)").option("--max-errors <number>","Stop after a certain number of errors","5").option("--max-feeds <number>","Stop search after finding a certain number of feeds","0").description(`Find feeds for site
`).action(async(m,e)=>{m?n.feeds=await A(m,e):n.help()});n.addOption(new _.Option("--display-errors","Display errors").hideHelp());n.parseAsync(process.argv).then(()=>{console.log(n.feeds)});
