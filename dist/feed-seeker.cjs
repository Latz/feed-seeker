#!/usr/bin/env node
"use strict";const a=require("linkedom"),r=require("./deepSearch-D_rN-MmK.cjs");class h extends r.EventEmitter{constructor(t,i={}){super(),this.rawSite=t;let e=t;e.includes("://")||(e=`https://${e}`);try{const s=new URL(e);this.site=s.pathname==="/"?s.origin:s.href}catch{this.site=e}this.options={timeout:5,...i},this.initPromise=null}async initialize(){return this.initPromise===null&&(this.initPromise=(async()=>{try{if(!this.rawSite||typeof this.rawSite!="string"){this.emit("error",{module:"FeedSeeker",error:"Site parameter must be a non-empty string"}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized");return}try{new URL(this.site)}catch{this.emit("error",{module:"FeedSeeker",error:`Invalid URL: ${this.site}`}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized");return}const t=await r.fetchWithTimeout(this.site,this.options.timeout*1e3);if(!t.ok){this.emit("error",{module:"FeedSeeker",error:`HTTP error while fetching ${this.site}: ${t.status} ${t.statusText}`}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized");return}this.content=await t.text();const{document:i}=a.parseHTML(this.content);this.document=i,this.emit("initialized")}catch(t){const i=t instanceof Error?t:new Error(String(t));let e=`Failed to fetch ${this.site}`;if(i.name==="AbortError")e+=": Request timed out";else{e+=`: ${i.message}`;const s=i.cause;s&&(e+=` (cause: ${s.code||s.message})`)}this.emit("error",{module:"FeedSeeker",error:e,cause:i.cause}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized")}})()),this.initPromise}async metaLinks(){return await this.initialize(),r.metaLinks(this)}async checkAllAnchors(){return await this.initialize(),r.checkAllAnchors(this)}async blindSearch(){return await this.initialize(),r.blindSearch(this)}async deepSearch(){return await this.initialize(),r.deepSearch(this.site,this.options,this)}async startSearch(){const t=await this.handleSingleStrategyMode();if(t)return t;const i=new Map;await this.collectFeedsFromStrategies(i),await this.handleDeepSearch(i);const e=this.getFeedsWithLimit(i);return this.emit("end",{module:"all",feeds:e}),e}async handleSingleStrategyMode(){const{deepsearchOnly:t,metasearch:i,blindsearch:e,anchorsonly:s}=this.options;return t?this.deepSearch():i?this.metaLinks():e?this.blindSearch():s?this.checkAllAnchors():null}async collectFeedsFromStrategies(t){const i=[this.metaLinks,this.checkAllAnchors,this.blindSearch];for(const e of i){const s=await e.call(this);if(this.addFeedsToMap(t,s),this.hasReachedLimit(t))break}}addFeedsToMap(t,i){if(!(!i||i.length===0))for(const e of i)t.has(e.url)||t.set(e.url,e)}hasReachedLimit(t){const{all:i,maxFeeds:e}=this.options;return!i&&e!==void 0&&e>0&&t.size>=e}async handleDeepSearch(t){const{deepsearch:i,maxFeeds:e}=this.options;if(!i||e&&t.size>=e)return;const s=await this.deepSearch();if(!(!s||s.length===0)){for(const n of s)if(t.has(n.url)||t.set(n.url,n),this.hasReachedLimit(t))break}}getFeedsWithLimit(t){const i=Array.from(t.values()),{maxFeeds:e}=this.options;return e!==void 0&&e>0&&i.length>e?i.slice(0,e):i}}module.exports=h;
