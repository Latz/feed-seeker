#!/usr/bin/env node
"use strict";const d=require("linkedom"),a=require("./deepSearch-B6Nx8Ryc.cjs"),m=require("./eventEmitter-CvqYYQvu.cjs"),f=require("./checkFeed-CUSfVVkN.cjs");class p extends m.EventEmitter{constructor(e,i={}){super(),e.includes("://")||(e=`https://${e}`);const s=new URL(e);this.site=s.pathname==="/"?s.origin:s.href,this.options=i,this.initPromise=null}async initialize(){return this.initPromise===null&&(this.initPromise=(async()=>{try{const e=await f.fetchWithTimeout(this.site,(this.options.timeout||5)*1e3);if(!e.ok){this.emit("error",{module:"FeedScout",error:`HTTP error while fetching ${this.site}: ${e.status} ${e.statusText}`}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized");return}this.content=await e.text();const{document:i}=d.parseHTML(this.content);this.document=i,this.emit("initialized")}catch(e){const i=e instanceof Error?e:new Error(String(e));let s=`Failed to fetch ${this.site}`;if(i.name==="AbortError")s+=": Request timed out";else{s+=`: ${i.message}`;const n=i.cause;n&&(s+=` (cause: ${n.code||n.message})`)}this.emit("error",{module:"FeedScout",error:s,cause:i.cause}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized")}})()),this.initPromise}async metaLinks(){return await this.initialize(),a.metaLinks(this)}async checkAllAnchors(){return await this.initialize(),a.checkAllAnchors(this)}async blindSearch(){return await this.initialize(),a.blindSearch(this)}async deepSearch(){return await this.initialize(),a.deepSearch(this.site,this.options,this)}async startSearch(){const{deepsearchOnly:e,metasearch:i,blindsearch:s,anchorsonly:n,deepsearch:o,all:l,maxFeeds:r}=this.options;if(e)return this.deepSearch();if(i)return this.metaLinks();if(s)return this.blindSearch();if(n)return this.checkAllAnchors();let t=[];const u=[this.metaLinks,this.checkAllAnchors,this.blindSearch];for(const c of u){const h=await c.call(this);if(h&&h.length>0&&(t=t.concat(h),!l&&r&&r>0&&t.length>=r)){t=t.slice(0,r);break}}if(o&&(!r||t.length<r)){const c=await this.deepSearch();c&&c.length>0&&(t=t.concat(c),r&&r>0&&t.length>r&&(t=t.slice(0,r)))}return this.emit("end",{module:"all",feeds:t}),t}}module.exports=p;
