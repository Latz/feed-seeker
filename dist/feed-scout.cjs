#!/usr/bin/env node
"use strict";const f=require("linkedom"),h=require("./deepSearch-B6Nx8Ryc.cjs"),p=require("./eventEmitter-CvqYYQvu.cjs"),y=require("./checkFeed-CUSfVVkN.cjs");class w extends p.EventEmitter{constructor(e,r={}){if(super(),!e||typeof e!="string")throw new TypeError("site parameter must be a non-empty string");e.includes("://")||(e=`https://${e}`);let i;try{i=new URL(e)}catch{throw new TypeError(`Invalid URL: ${e}`)}this.site=i.pathname==="/"?i.origin:i.href,this.options={timeout:5,...r},this.initPromise=null}async initialize(){return this.initPromise===null&&(this.initPromise=(async()=>{try{const e=await y.fetchWithTimeout(this.site,this.options.timeout*1e3);if(!e.ok){this.emit("error",{module:"FeedScout",error:`HTTP error while fetching ${this.site}: ${e.status} ${e.statusText}`}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized");return}this.content=await e.text();const{document:r}=f.parseHTML(this.content);this.document=r,this.emit("initialized")}catch(e){const r=e instanceof Error?e:new Error(String(e));let i=`Failed to fetch ${this.site}`;if(r.name==="AbortError")i+=": Request timed out";else{i+=`: ${r.message}`;const a=r.cause;a&&(i+=` (cause: ${a.code||a.message})`)}this.emit("error",{module:"FeedScout",error:i,cause:r.cause}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized")}})()),this.initPromise}async metaLinks(){return await this.initialize(),h.metaLinks(this)}async checkAllAnchors(){return await this.initialize(),h.checkAllAnchors(this)}async blindSearch(){return await this.initialize(),h.blindSearch(this)}async deepSearch(){return await this.initialize(),h.deepSearch(this.site,this.options,this)}async startSearch(){const{deepsearchOnly:e,metasearch:r,blindsearch:i,anchorsonly:a,deepsearch:u,all:d,maxFeeds:t}=this.options;if(e)return this.deepSearch();if(r)return this.metaLinks();if(i)return this.blindSearch();if(a)return this.checkAllAnchors();const s=new Map,m=[this.metaLinks,this.checkAllAnchors,this.blindSearch];for(const c of m){const n=await c.call(this);if(n&&n.length>0){for(const l of n)s.has(l.url)||s.set(l.url,l);if(!d&&t&&t>0&&s.size>=t)break}}if(u&&(!t||s.size<t)){const c=await this.deepSearch();if(c&&c.length>0){for(const n of c)if(s.has(n.url)||s.set(n.url,n),t&&t>0&&s.size>=t)break}}let o=Array.from(s.values());return t&&t>0&&o.length>t&&(o=o.slice(0,t)),this.emit("end",{module:"all",feeds:o}),o}}module.exports=w;
