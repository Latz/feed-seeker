#!/usr/bin/env node
"use strict";const d=require("linkedom"),c=require("./deepSearch-B6Nx8Ryc.cjs"),m=require("./eventEmitter-CvqYYQvu.cjs"),f=require("./checkFeed-CUSfVVkN.cjs");class p extends m.EventEmitter{constructor(e,i={}){super(),e.includes("://")||(e=`https://${e}`);const r=new URL(e);this.site=r.pathname==="/"?r.origin:r.href,this.options=i,this.initPromise=null}async initialize(){return this.initPromise===null&&(this.initPromise=(async()=>{try{const e=await f.fetchWithTimeout(this.site,(this.options.timeout||5)*1e3);if(!e.ok){this.emit("error",{module:"FeedScout",error:`HTTP error while fetching ${this.site}: ${e.status} ${e.statusText}`}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized");return}this.content=await e.text();const{document:i}=d.parseHTML(this.content);this.document=i,this.emit("initialized")}catch(e){let i=`Failed to fetch ${this.site}`;e.name==="AbortError"?i+=": Request timed out":(i+=`: ${e.message}`,e.cause&&(i+=` (cause: ${e.cause.code||e.cause.message})`)),this.emit("error",{module:"FeedScout",error:i,cause:e.cause}),this.content="",this.document={querySelectorAll:()=>[]},this.emit("initialized")}})()),this.initPromise}async metaLinks(){return await this.initialize(),c.metaLinks(this)}async checkAllAnchors(){return await this.initialize(),c.checkAllAnchors(this)}async blindSearch(){return await this.initialize(),c.blindSearch(this)}async deepSearch(){return await this.initialize(),c.deepSearch(this.site,this.options,this)}async startSearch(){const{deepsearchOnly:e,metasearch:i,blindsearch:r,anchorsonly:h,deepsearch:o,all:l,maxFeeds:s}=this.options;if(e)return this.deepSearch();if(i)return this.metaLinks();if(r)return this.blindSearch();if(h)return this.checkAllAnchors();let t=[];const u=[this.metaLinks,this.checkAllAnchors,this.blindSearch];for(const n of u){const a=await n.call(this);if(a&&a.length>0&&(t=t.concat(a),!l&&s&&s>0&&t.length>=s)){t=t.slice(0,s);break}}if(o&&(!s||t.length<s)){const n=await this.deepSearch();n&&n.length>0&&(t=t.concat(n),s&&s>0&&t.length>s&&(t=t.slice(0,s)))}return this.emit("end",{module:"all",feeds:t}),t}}module.exports=p;
