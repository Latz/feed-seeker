"use strict";const j=require("linkedom"),S=require("tldts"),H=require("async");async function C(t,e={}){let r,s;if(typeof e=="number")r=e,s={};else{const{timeout:a=5e3,...d}=e;r=a,s=d}try{const a=new URL(t);if(!["http:","https:"].includes(a.protocol))throw new Error(`Invalid URL protocol: ${a.protocol}. Only http: and https: are allowed.`)}catch(a){throw a instanceof TypeError?new Error(`Invalid URL: ${t}`):a}if(r<=0)throw new Error(`Invalid timeout: ${r}. Timeout must be a positive number.`);if(!Number.isFinite(r))throw new Error(`Invalid timeout: ${r}. Timeout must be a finite number.`);const o=new AbortController,i=setTimeout(()=>o.abort(),r),l={...{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive","Upgrade-Insecure-Requests":"1","Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"none","Cache-Control":"max-age=0"},...s.headers||{}};try{const a=await fetch(t,{...s,signal:o.signal,headers:l});return clearTimeout(i),a}catch(a){throw clearTimeout(i),a instanceof Error&&a.name==="AbortError"?new Error(`Request to ${t} timed out after ${r}ms`):a}}const m={MAX_CONTENT_SIZE:10*1024*1024,DEFAULT_TIMEOUT:5,MAX_TIMEOUT:60,MIN_TIMEOUT:1},M={TYPES:["rich","video","photo","link"],VERSIONS:["1.0","2.0"],URL_PATTERNS:["/wp-json/oembed/","/oembed"]},f={CDATA:/<!\[CDATA\[(.*?)\]\]>/g,RSS:{VERSION:/<rss[^>]*\s+version\s*=\s*["'][\d.]+["'][^>]*>/i,CHANNEL:/<channel[^>]*>/i,ITEM:/<item[^>]*>/i,DESCRIPTION:/<description[^>]*>/i,CHANNEL_END:/<\/channel>/i,CHANNEL_CONTENT:/<channel>([\s\S]*?)<\/channel>/i,TITLE:/<title>([\s\S]*?)<\/title>/i},ATOM:{FEED_START:/<feed(?:\s+[^>]*)?>/i,NAMESPACE_XMLNS:/<feed[^>]*xmlns[^>]*atom/i,NAMESPACE_XMLNS_ATOM:/<feed[^>]*xmlns:atom/i,NAMESPACE_ATOM_PREFIX:/<feed[^>]*atom:/i,ENTRY:/<entry[^>]*>/i,TITLE_TAG:/<title[^>]*>/i,TITLE_CONTENT:/<title>([\s\S]*?)<\/title>/i}};function X(t){let e;try{e=new URL(t)}catch{throw new Error(`Invalid URL: ${t}`)}if(!["http:","https:"].includes(e.protocol))throw new Error(`Invalid protocol: ${e.protocol}. Only http: and https: protocols are allowed.`)}function W(t){if(t.length>m.MAX_CONTENT_SIZE)throw new Error(`Content too large: ${t.length} bytes. Maximum allowed: ${m.MAX_CONTENT_SIZE} bytes.`)}function V(t){return t==null?m.DEFAULT_TIMEOUT:!Number.isFinite(t)||t<m.MIN_TIMEOUT?(console.warn(`Invalid timeout value ${t}. Using minimum: ${m.MIN_TIMEOUT} seconds.`),m.MIN_TIMEOUT):t>m.MAX_TIMEOUT?(console.warn(`Timeout value ${t} exceeds maximum. Clamping to ${m.MAX_TIMEOUT} seconds.`),m.MAX_TIMEOUT):Math.floor(t)}function Y(t){return M.URL_PATTERNS.some(e=>t.includes(e))}function G(t){return!!(t.type&&M.TYPES.includes(t.type)&&M.VERSIONS.includes(t.version)||t.type&&t.version&&t.html)}function N(t){return t.replace(f.CDATA,"$1")}function x(t){return t?t.replace(/\s+/g," ").trim():null}async function w(t,e="",r){if(X(t),Y(t))return null;if(!e){if(!r)throw new Error("Instance parameter is required when content is not provided");const i=V(r.options.timeout)*1e3,n=await C(t,i);if(!n.ok)throw new Error(`Failed to fetch ${t}: ${n.status} ${n.statusText}`);e=await n.text()}return W(e),J(e)||Q(e)||Z(e)||null}function B(t){const e=f.RSS.CHANNEL_CONTENT.exec(t);if(e){const o=e[1],i=f.RSS.TITLE.exec(o);return i?x(N(i[1])):null}const r=f.RSS.TITLE.exec(t);return r?x(N(r[1])):null}function J(t){if(f.RSS.VERSION.test(t)){const e=f.RSS.CHANNEL.test(t),r=f.RSS.ITEM.test(t),s=f.RSS.DESCRIPTION.test(t);if(e&&s&&(r||f.RSS.CHANNEL_END.test(t)))return{type:"rss",title:B(t)}}return null}function Q(t){const e=f.ATOM.NAMESPACE_XMLNS.test(t)||f.ATOM.NAMESPACE_XMLNS_ATOM.test(t)||f.ATOM.NAMESPACE_ATOM_PREFIX.test(t);if(f.ATOM.FEED_START.test(t)&&e){const r=f.ATOM.ENTRY.test(t),s=f.ATOM.TITLE_TAG.test(t);if(r&&s){const o=f.ATOM.TITLE_CONTENT.exec(t);return{type:"atom",title:o?x(N(o[1])):null}}}return null}function Z(t){try{const e=JSON.parse(t);if(G(e))return null;if(e.version&&typeof e.version=="string"&&e.version.includes("jsonfeed")||e.items&&Array.isArray(e.items)||e.feed_url){const r=e.title||e.name||null;return{type:"json",title:typeof r=="string"?x(r):null}}return null}catch{return null}}const K=["feed+json","rss+xml","atom+xml","xml","rdf+xml"],ee=["/rss","/feed","/atom",".rss",".atom",".xml",".json"];function te(t){return t?t.replace(/\s+/g," ").trim():null}async function b(t,e,r,s,o=5){const i=e.options?.maxFeeds||0;for(let n=0;n<t.length;n+=o){if(i>0&&r.length>=i)return!0;const l=t.slice(n,n+o);if((await Promise.allSettled(l.map(c=>re(c,e,r,s)))).some(c=>c.status==="fulfilled"&&c.value===!0))return!0}return!1}async function re(t,e,r,s){const o=e.options?.maxFeeds||0;if(!t.href)return!1;let i;try{i=new URL(t.href,e.site).href}catch(n){if(e.options?.showErrors){const l=n instanceof Error?n:new Error(String(n));e.emit("error",{module:"metalinks",error:l.message,explanation:`Invalid URL found in meta link: ${t.href}. Unable to construct a valid URL.`,suggestion:"Check the meta link href attribute for malformed URLs."})}return!1}if(s.has(i))return!1;e.emit("log",{module:"metalinks",message:`Checking feed: ${i}`});try{const n=await w(i,"",e);if(n&&(r.push({url:i,title:te(t.title),type:n.type,feedTitle:n.title}),s.add(i),o>0&&r.length>=o))return e.emit("log",{module:"metalinks",message:`Stopped due to reaching maximum feeds limit: ${r.length} feeds found (max ${o} allowed).`}),!0}catch(n){if(e.options?.showErrors){const l=n instanceof Error?n:new Error(String(n));e.emit("error",{module:"metalinks",error:l.message,explanation:"An error occurred while trying to fetch and validate a feed URL found in a meta link tag. This could be due to network issues, server problems, or invalid feed content.",suggestion:"Check if the meta link URL is accessible and returns valid feed content. The search will continue with other meta links."})}}return!1}async function se(t){t.emit("start",{module:"metalinks",niceName:"Meta links"});const e=[],r=new Set;try{const s=K.map(d=>`link[type="application/${d}"]`).join(", "),o=Array.from(t.document.querySelectorAll(s));if(await b(o,t,e,r))return e;const n=Array.from(t.document.querySelectorAll('link[rel="alternate"][type*="rss"], link[rel="alternate"][type*="xml"], link[rel="alternate"][type*="atom"], link[rel="alternate"][type*="json"]'));if(await b(n,t,e,r))return e;const a=Array.from(t.document.querySelectorAll('link[rel="alternate"]')).filter(d=>d.href&&ee.some(c=>d.href.toLowerCase().includes(c)));return await b(a,t,e,r),e}finally{t.emit("end",{module:"metalinks",feeds:e})}}function y(t,e){try{return new URL(t,e)}catch{return null}}function oe(t){const e=y(t);return e?e.protocol==="http:"||e.protocol==="https:":!1}function ie(t){return y(t)?!1:!t.includes("://")}function I(t,e){const r=y(t);if(!r||r.hostname===e.hostname)return!0;const s=["feedburner.com","feeds.feedburner.com","feedproxy.google.com","feeds2.feedburner.com"];return s.includes(r.hostname)||s.some(o=>r.hostname.endsWith("."+o))}function ne(t){if(t.options.followMetaRefresh&&t.document&&typeof t.document.querySelector=="function"){const e=t.document.querySelector('meta[http-equiv="refresh"]')?.getAttribute("content");if(e){const r=e.match(/url=(.*)/i);if(r&&r[1]){const s=new URL(r[1],t.site).href;return t.emit("log",{module:"anchors",message:`Following meta refresh redirect to ${s}`}),q({...t,site:s})}}}return null}function D(t,e,r){if(!t.href)return null;if(oe(t.href))return t.href;if(ie(t.href)){const s=y(t.href,e);return s?s.href:(r.emit("error",{module:"anchors",error:`Invalid relative URL: ${t.href}`,explanation:"A relative URL found in an anchor tag could not be resolved against the base URL. This may be due to malformed relative path syntax.",suggestion:'Check the anchor href attribute for proper relative path format (e.g., "./feed.xml", "../rss.xml", or "/feed").'}),null)}return null}function ae(t){const e=/https?:\/\/[^\s"'<>)]+/gi,r=t.match(e);if(!r)return[];const s=new Set;for(const o of r){const i=o.replace(/[.,;:!?]+$/,"");s.add(i)}return Array.from(s)}async function le(t,e){const{instance:r,baseUrl:s,feedUrls:o}=e,i=D(t,s,r);if(i)try{const n=await w(i,"",r);n&&o.push({url:i,title:t.textContent?.trim()||null,type:n.type,feedTitle:n.title})}catch(n){if(r.options?.showErrors){const l=n instanceof Error?n:new Error(String(n));r.emit("error",{module:"anchors",error:`Error checking feed at ${i}: ${l.message}`,explanation:"An error occurred while trying to fetch and validate a potential feed URL found in an anchor tag. This could be due to network timeouts, server errors, or invalid feed content.",suggestion:"Check if the URL is accessible and returns valid feed content. Network connectivity issues or server problems may cause this error."})}}}async function q(t){await ne(t);const e=new URL(t.site),r=t.document.querySelectorAll("a"),s=[];for(const l of r){const a=D(l,e,t);a&&I(a,e)&&s.push(l)}const o=t.options?.maxFeeds||0,i={instance:t,baseUrl:e,feedUrls:[]};let n=1;for(const l of s){if(o>0&&i.feedUrls.length>=o){t.emit("log",{module:"anchors",message:`Stopped due to reaching maximum feeds limit: ${i.feedUrls.length} feeds found (max ${o} allowed).`});break}t.emit("log",{module:"anchors",totalCount:n++,totalEndpoints:s.length}),await le(l,i)}if(o===0||i.feedUrls.length<o){const l=t.document.body?.innerHTML||"",a=ae(l),d=new Set(i.feedUrls.map(u=>u.url)),c=[];for(const u of a)!d.has(u)&&I(u,e)&&(c.push(u),d.add(u));for(const u of c){if(o>0&&i.feedUrls.length>=o){t.emit("log",{module:"anchors",message:`Stopped due to reaching maximum feeds limit: ${i.feedUrls.length} feeds found (max ${o} allowed).`});break}t.emit("log",{module:"anchors",totalCount:n++,totalEndpoints:s.length+c.length});try{const h=await w(u,"",t);h&&i.feedUrls.push({url:u,title:null,type:h.type,feedTitle:h.title})}catch(h){if(t.options?.showErrors){const T=h instanceof Error?h:new Error(String(h));t.emit("error",{module:"anchors",error:`Error checking feed at ${u}: ${T.message}`,explanation:"An error occurred while trying to fetch and validate a potential feed URL found in page text. This could be due to network timeouts, server errors, or invalid feed content.",suggestion:"Check if the URL is accessible and returns valid feed content. Network connectivity issues or server problems may cause this error."})}}}}return i.feedUrls}async function de(t){t.emit("start",{module:"anchors",niceName:"Check all anchors"});const e=await q(t);return t.emit("end",{module:"anchors",feeds:e}),e}const ce=0,L=0,fe=3,A="standard",P=2083,U=10,v=1,_=1e4,k=6e4,E=["feed","rss","atom","feed.xml","rss.xml","atom.xml","index.xml","feeds",".rss",".atom",".xml","?feed=rss2","?feed=atom","feed/rss/","feed/atom/","blog/feed","blog/rss","feed.json","rss.php","feed.php","news/rss","latest/feed","?format=rss","?format=feed"],R=["rssfeed.xml","feed.rss","feed.atom","feeds/","rss/","index.rss","index.atom","rss/index.xml","atom/index.xml","syndication/","rssfeed.rdf","&_rss=1","blog/atom","blog/feeds","blog?format=rss","blog-feed.xml","weblog/atom","weblog/rss","?format=feed","feed/rdf/","feed/rss2/","wp-atom.php","wp-feed.php","wp-rdf.php","wp-rss.php","wp-rss2.php","index.php?format=feed","articles/feed","atom/news/","latest.rss","news.xml","news/atom","rss/articles/","rss/latest/","rss/news/","rss/news/rss.xml","rss/rss.php","api/feed","api/rss","api/atom","api/rss.xml","api/feed.xml","api/v1/feed","api/v2/feed","v1/feed","v2/feed","feed.aspx","rss.aspx","rss.cfm","feed.jsp","feed.pl","feed.py","feed.rb","feed/atom","feed/rdf","feed/atom.rss","feed/atom.xml","feed/rss.xml","feed/rss2","posts.rss","_site/feed.xml","build/feed.xml","dist/feed.xml","out/feed.xml","?atom=1","?rss=1","?feed=atom","?feed=rss","?format=atom","?output=rss","?output=atom","?type=rss","?type=atom","?view=feed","?view=rss"],ue=["atomfeed","jsonfeed","newsfeed","rssfeed","feeds.json","feeds.php","feeds.xml",".json",".opml",".rdf","opml","opml/","rdf","rdf/","feed.cml","feed.csv","feed.txt","feed.yaml","feed.yml","?download=atom","?download=rss","?export=atom","?export=rss","?syndicate=atom","?syndicate=rss","export/rss.xml","extern.php?action=feed&type=atom","external?type=rss2","index.php?action=.xml;type=rss","public/feed.xml","spip.php?page=backend","spip.php?page=backend-breve","spip.php?page=backend-sites","syndicate/rss.xml","syndication.php","xml","sitenews","api/mobile/feed","catalog.xml","catalog/feed","deals.xml","deals/feed","inventory.rss","inventory/feed","products.rss","products/atom","products/rss","promotions/feed","specials/feed","audio/feed","episodes.rss","episodes/feed","gallery.rss","media/feed","podcast.rss","podcast/atom","podcast/rss","podcasts/feed","shows/feed","video/feed","videos.rss","comments/feed","community/feed","discussions/feed","forum.rss","forum/atom","forum/rss","reviews/feed","agenda/feed","calendar/feed","events.rss","events/feed","schedule/feed","careers/feed","jobs.rss","jobs/feed","opportunities/feed","vacancies/feed","content/feed","documents/feed","pages/feed","resources/feed","emails/feed","mailinglist/feed","newsletter/feed","subscription/feed","category/*/feed","tag/*/feed","tags/feed","topics/feed","author/*/feed","profile/*/feed","user/*/feed","archive/feed","daily/feed","monthly/feed","weekly/feed","yearly/feed","announcements/feed","changelog/feed","press/feed","updates/feed","revisions/feed","app/feed","mobile/feed","international/feed","local/feed","national/feed","regional/feed","education/feed","entertainment/feed","finance/feed","health/feed","industry/feed","market/feed","science/feed","sector/feed","sports/feed","technology/feed","aggregate/feed","all/feed","combined/feed","compilation/feed","everything/feed","actualites/feed","nachrichten/feed","nieuws/feed","noticias/feed","novosti/feed","cms/feed","contentful/feed","sanity/feed","strapi/feed","docs/feed","documentation/feed","help/feed","kb/feed","support/feed","wiki/feed","branches/feed","commits/feed","issues/feed","pull-requests/feed","releases/feed","tags/feed","analytics/feed","metrics/feed","reports/feed","stats/feed","de/feed","en/feed","es/feed","fr/feed","it/feed","ja/feed","ko/feed","pt/feed","ru/feed","zh/feed","drupal/feed","joomla/feed","magento/feed","opencart/feed","prestashop/feed","shopify/feed","typo3/feed","woocommerce/feed","discourse/feed","invision/feed","phpbb/feed","vbulletin/feed","xenforo/feed"];function he(t){switch(t){case"fast":return E;case"standard":return[...E,...R];case"exhaustive":case"full":return[...E,...R,...ue];default:return[...E,...R]}}function me(t){return t?["fast","standard","exhaustive","full"].includes(t)?t:(console.warn(`Invalid search mode "${t}". Falling back to "${A}".`),A):A}function pe(t){return t==null?fe:!Number.isFinite(t)||t<v?(console.warn(`Invalid concurrency value ${t}. Using minimum: ${v}.`),v):t>U?(console.warn(`Concurrency value ${t} exceeds maximum. Clamping to ${U}.`),U):Math.floor(t)}function ge(t){return t==null?L:!Number.isFinite(t)||t<0?(console.warn(`Invalid request delay ${t}. Using default: ${L}.`),L):t>k?(console.warn(`Request delay ${t}ms exceeds maximum. Clamping to ${k}ms.`),k):Math.floor(t)}function F(t){return t.length<=P}function we(t,e,r){let s;try{s=new URL(t)}catch{throw new Error(`Invalid URL provided to blindSearch: ${t}`)}if(!F(t))throw new Error(`URL too long (${t.length} chars). Maximum allowed: ${P} characters.`);if(!["http:","https:"].includes(s.protocol))throw new Error(`Invalid protocol "${s.protocol}". Only http: and https: are allowed.`);const o=s.origin;let i=t;const n=[];let l="";for(e&&(l=s.search);i.length>=o.length;){const a=i.endsWith("/")?i.slice(0,-1):i;for(const d of r){if(n.length>=_)return console.warn(`URL generation limit reached (${_} URLs). Stopping to prevent resource exhaustion.`),n;const c=l?`${a}/${d}${l}`:`${a}/${d}`;F(c)?n.push(c):console.warn(`Skipping URL (too long): ${c.substring(0,100)}...`)}i=i.slice(0,i.lastIndexOf("/"))}return n}function Ee(t,e,r,s,o){return t.type==="rss"?s=!0:t.type==="atom"&&(o=!0),r.push({url:e,title:null,type:t.type,feedTitle:t.title,feedType:t.type}),{rssFound:s,atomFound:o}}function xe(t,e,r,s,o){return t>=e?!1:o?!0:!(r&&s)}async function ye(t,e){const r=me(t.options?.searchMode),s=he(r),o=we(t.site,t.options?.keepQueryParams||!1,s);t.emit("start",{module:"blindsearch",niceName:"Blind search",endpointUrls:o.length});const i=t.options?.all||!1,n=t.options?.maxFeeds??ce,l=pe(t.options?.concurrency),a=await Te(o,i,n,l,t);return t.emit("end",{module:"blindsearch",feeds:a.feeds}),a.feeds}async function Te(t,e,r,s,o,i){const n=[],l=new Set;let a=!1,d=!1,c=0;for(;xe(c,t.length,a,d,e);){if(r>0&&n.length>=r){await O(o,n,r);break}const u=Math.min(s,t.length-c),h=t.slice(c,c+u),T=await Promise.allSettled(h.map(p=>Se(p,o,l,n,a,d)));for(const p of T)if(p.status==="fulfilled"&&p.value.found&&(a=p.value.rssFound,d=p.value.atomFound,r>0&&n.length>=r)){await O(o,n,r),c=t.length;break}c+=u;const z=n.length;o.emit("log",{module:"blindsearch",totalEndpoints:t.length,totalCount:c,feedsFound:z});const $=ge(o.options?.requestDelay);$>0&&c<t.length&&await new Promise(p=>setTimeout(p,$))}return{feeds:n,rssFound:a,atomFound:d}}async function Se(t,e,r,s,o,i){if(r.has(t))return{found:!1,rssFound:o,atomFound:i};r.add(t);try{const n=await w(t,"",e);if(n){const l=Ee(n,t,s,o,i);return o=l.rssFound,i=l.atomFound,{found:!0,rssFound:o,atomFound:i}}}catch(n){const l=n instanceof Error?n:new Error(String(n));await be(e,t,l)}return{found:!1,rssFound:o,atomFound:i}}async function O(t,e,r){t.emit("log",{module:"blindsearch",message:`Stopped due to reaching maximum feeds limit: ${e.length} feeds found (max ${r} allowed).`})}async function be(t,e,r){t.options?.showErrors&&t.emit("error",{module:"blindsearch",error:`Error fetching ${e}: ${r.message}`,explanation:"An error occurred while trying to fetch a potential feed URL during blind search. This could be due to network timeouts, server errors, 404 not found, or invalid content.",suggestion:"This is normal during blind search as many URLs are tested. The search will continue with other potential feed endpoints."})}class g{#e=new Map;#t;#o;static#i=10;constructor(e={}){this.#t=e.maxListeners??g.#i,this.#o=e.captureAsyncErrors??!0}static setDefaultMaxListeners(e){if(typeof e!="number"||e<0||!Number.isInteger(e))throw new TypeError("Max listeners must be a non-negative integer");g.#i=e}#r(e){if(typeof e!="string"||e.trim().length===0)throw new TypeError("Event must be a non-empty string")}#s(e){if(typeof e!="function")throw new TypeError("Listener must be a function")}#n(e){if(this.#t>0){const r=this.listenerCount(e);r>this.#t&&console.warn(`Warning: Possible EventEmitter memory leak detected. ${r} ${e} listeners added. Use emitter.setMaxListeners() to increase limit`)}}#l(e){if(e instanceof Error)return e.message;if(typeof e=="object"&&e!==null){const r=e;if(typeof r.error=="string")return r.error;if(typeof r.message=="string")return r.message;try{return JSON.stringify(r)}catch{return String(e)}}return String(e)}#a(e,r){if(r==="error")throw console.error("Error in error event listener:",e),e;const s=this.#e.get("error");if(s&&s.size>0)this.emit("error",e,r);else throw console.error(`Unhandled error in event listener for '${r}':`,e),e}on(e,r){this.#r(e),this.#s(r);const s=this.#e.get(e);return s?s.add(r):this.#e.set(e,new Set([r])),this.#n(e),this}prependListener(e,r){this.#r(e),this.#s(r);const s=this.#e.get(e);if(!s)this.#e.set(e,new Set([r]));else{const o=new Set([r,...s]);this.#e.set(e,o)}return this.#n(e),this}once(e,r){this.#r(e),this.#s(r);const s=((...o)=>{this.off(e,s),r(...o)});return s.originalListener=r,this.on(e,s)}prependOnceListener(e,r){this.#r(e),this.#s(r);const s=((...o)=>{this.off(e,s),r(...o)});return s.originalListener=r,this.prependListener(e,s)}emit(e,...r){const s=this.#e.get(e);if(!s||s.size===0){if(e==="error"){const o=r[0];if(o instanceof Error)throw o;{const i=this.#l(o);throw new Error(`Unhandled error event: ${i}`)}}return!1}return[...s].forEach(o=>{try{const i=o(...r);this.#o&&i instanceof Promise&&i.catch(n=>{this.#a(n,e)})}catch(i){this.#a(i,e)}}),!0}off(e,r){const s=this.#e.get(e);return s?([...s].forEach(o=>{(o===r||o.originalListener===r)&&s.delete(o)}),s.size===0&&this.#e.delete(e),this):this}removeAllListeners(e){return e?(this.#r(e),this.#e.delete(e)):this.#e.clear(),this}setMaxListeners(e){if(typeof e!="number"||e<0||!Number.isInteger(e))throw new TypeError("Max listeners must be a non-negative integer");return this.#t=e,this}getMaxListeners(){return this.#t}listenerCount(e){const r=this.#e.get(e);return r?r.size:0}listeners(e){const r=this.#e.get(e);return r?[...r].map(s=>s.originalListener||s):[]}rawListeners(e){const r=this.#e.get(e);return r?[...r]:[]}eventNames(){return Array.from(this.#e.keys())}}function Le(t){return[".zip",".rar",".7z",".tar.gz",".tar.bz2",".tar.xz",".tar",".gz",".bz2",".xz",".tgz",".epub",".mobi",".azw",".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".jpg",".jpeg",".png",".gif",".bmp",".tiff",".svg",".mp3",".mp4",".avi",".mov",".wmv",".mpg",".mpeg",".flv",".mkv",".webm",".ogg",".ogv",".ogx"].some(r=>t.endsWith(r))}class Ae extends g{constructor(e,r=3,s=5,o=1e3,i=!1,n=5,l=0,a=null){super();try{const d=new URL(e);this.startUrl=d.href}catch{throw new Error(`Invalid start URL: ${e}`)}this.maxDepth=r,this.concurrency=s,this.maxLinks=o,this.mainDomain=S.getDomain(this.startUrl),this.checkForeignFeeds=i,this.maxErrors=n,this.maxFeeds=l,this.errorCount=0,this.instance=a,this.queue=H.queue(this.crawlPage.bind(this),this.concurrency),this.visitedUrls=new Set,this.timeout=5e3,this.maxLinksReachedMessageEmitted=!1,this.feeds=[],this.queue.error(d=>{this.errorCount<this.maxErrors&&(this.errorCount++,this.emit("error",{module:"deepSearch",error:`Async error: ${d}`,explanation:"An error occurred in the async queue while processing a crawling task. This could be due to network issues, invalid URLs, or server problems.",suggestion:"Check network connectivity and ensure the target website is accessible. The crawler will continue with other URLs."}),this.errorCount>=this.maxErrors&&(this.queue.kill(),this.emit("log",{module:"deepSearch",message:`Stopped due to ${this.errorCount} errors (max ${this.maxErrors} allowed).`})))})}start(){this.queue.push({url:this.startUrl,depth:0}),this.emit("start",{module:"deepSearch",niceName:"Deep search"})}isValidUrl(e){try{const r=S.getDomain(e)===S.getDomain(this.startUrl),s=!Le(e);return r&&s}catch{return this.errorCount<this.maxErrors&&(this.errorCount++,this.emit("error",{module:"deepSearch",error:`Invalid URL: ${e}`,explanation:"A URL encountered during crawling could not be parsed or validated. This may be due to malformed URL syntax or unsupported URL schemes.",suggestion:"This is usually caused by broken links on the website. The crawler will skip this URL and continue with others."}),this.errorCount>=this.maxErrors&&(this.queue.kill(),this.emit("log",{module:"deepSearch",message:`Stopped due to ${this.errorCount} errors (max ${this.maxErrors} allowed).`}))),!1}}shouldCrawl(e,r){return r>this.maxDepth||this.visitedUrls.has(e)?!1:this.visitedUrls.size>=this.maxLinks?(this.maxLinksReachedMessageEmitted||(this.emit("log",{module:"deepSearch",message:`Max links limit of ${this.maxLinks} reached. Stopping deep search.`}),this.maxLinksReachedMessageEmitted=!0),!1):this.isValidUrl(e)}handleFetchError(e,r,s){return this.errorCount<this.maxErrors&&(this.errorCount++,this.emit("log",{module:"deepSearch",url:e,depth:r,error:s}),this.errorCount>=this.maxErrors)?(this.queue.kill(),this.emit("log",{module:"deepSearch",message:`Stopped due to ${this.errorCount} errors (max ${this.maxErrors} allowed).`}),!0):!1}async processLink(e,r){if(this.visitedUrls.has(e))return!1;if(this.visitedUrls.size>=this.maxLinks)return this.maxLinksReachedMessageEmitted||(this.emit("log",{module:"deepSearch",message:`Max links limit of ${this.maxLinks} reached. Stopping deep search.`}),this.maxLinksReachedMessageEmitted=!0),!0;if(!(this.isValidUrl(e)||this.checkForeignFeeds))return!1;const o=this.queue.length();this.emit("log",{module:"deepSearch",url:e,depth:r,progress:{processed:this.visitedUrls.size,remaining:o}});try{const i=await w(e,"",this.instance||void 0);if(i&&!this.feeds.some(n=>n.url===e)){if(this.feeds.push({url:e,type:i.type,title:i.title,feedTitle:i.title}),this.emit("log",{module:"deepSearch",url:e,depth:r+1,feedCheck:{isFeed:!0,type:i.type}}),this.maxFeeds>0&&this.feeds.length>=this.maxFeeds)return this.queue.kill(),this.emit("log",{module:"deepSearch",message:`Stopped due to reaching maximum feeds limit: ${this.feeds.length} feeds found (max ${this.maxFeeds} allowed).`}),!0}else i||this.emit("log",{module:"deepSearch",url:e,depth:r+1,feedCheck:{isFeed:!1}})}catch(i){const n=i instanceof Error?i:new Error(String(i));return this.handleFetchError(e,r+1,`Error checking feed: ${n.message}`)}return r+1<=this.maxDepth&&this.isValidUrl(e)&&this.queue.push({url:e,depth:r+1}),!1}async crawlPage(e){let{url:r,depth:s}=e;if(!this.shouldCrawl(r,s))return;this.visitedUrls.add(r);const o=await C(r,this.timeout);if(!o){this.handleFetchError(r,s,"Failed to fetch URL - timeout or network error");return}if(!o.ok){this.handleFetchError(r,s,`HTTP ${o.status} ${o.statusText}`);return}const i=await o.text(),{document:n}=j.parseHTML(i);for(const l of n.querySelectorAll("a"))try{const a=new URL(l.href,this.startUrl).href;if(await this.processLink(a,s))break}catch{continue}}}async function Ue(t,e={},r=null){const s=new Ae(t,e.depth||3,5,e.maxLinks||1e3,!!e.checkForeignFeeds,e.maxErrors||5,e.maxFeeds||0,r);return s.timeout=(e.timeout||5)*1e3,r&&r.emit&&(s.on("start",o=>r.emit("start",o)),s.on("log",o=>r.emit("log",o)),s.on("error",o=>r.emit("error",o)),s.on("end",o=>r.emit("end",o))),s.start(),await new Promise(o=>{s.queue.drain(()=>{s.emit("end",{module:"deepSearch",feeds:s.feeds,visitedUrls:s.visitedUrls.size}),o()})}),s.feeds}exports.EventEmitter=g;exports.blindSearch=ye;exports.checkAllAnchors=de;exports.deepSearch=Ue;exports.fetchWithTimeout=C;exports.metaLinks=se;
