"use strict";const m=require("../checkFeed-CUSfVVkN.cjs");function u(r){return r?r.replace(/\s+/g," ").trim():null}async function a(r,t,l,s){const n=t.options?.maxFeeds||0;if(!r.href)return!1;const o=new URL(r.href,t.site).href;if(s.has(o))return!1;t.emit("log",{module:"metalinks"});try{const e=await m.checkFeed(o,"",t);if(e&&(l.push({url:o,title:u(r.title),type:e.type,feedTitle:e.title}),s.add(o),n>0&&l.length>=n))return t.emit("log",{module:"metalinks",message:`Stopped due to reaching maximum feeds limit: ${l.length} feeds found (max ${n} allowed).`}),!0}catch(e){if(t.options?.showErrors){const i=e instanceof Error?e:new Error(String(e));t.emit("error",{module:"metalinks",error:i.message,explanation:"An error occurred while trying to fetch and validate a feed URL found in a meta link tag. This could be due to network issues, server problems, or invalid feed content.",suggestion:"Check if the meta link URL is accessible and returns valid feed content. The search will continue with other meta links."})}}return!1}async function d(r){r.emit("start",{module:"metalinks",niceName:"Meta links"});const t=[],l=new Set,n=["feed+json","rss+xml","atom+xml","xml","rdf+xml"].map(e=>`link[type="application/${e}"]`).join(", ");for(const e of r.document.querySelectorAll(n))if(await a(e,r,t,l))return t;const o='link[rel="alternate"][type*="rss"], link[rel="alternate"][type*="xml"], link[rel="alternate"][type*="atom"], link[rel="alternate"][type*="json"]';for(const e of r.document.querySelectorAll(o))if(await a(e,r,t,l))return t;for(const e of r.document.querySelectorAll('link[rel="alternate"]')){const i=["/rss","/feed","/atom",".rss",".atom",".xml",".json"];if(e.href&&i.some(f=>e.href.toLowerCase().includes(f))&&await a(e,r,t,l))return t}return r.emit("end",{module:"metalinks",feeds:t}),t}module.exports=d;
