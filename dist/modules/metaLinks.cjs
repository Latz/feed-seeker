"use strict";const f=require("../checkFeed-CUSfVVkN.cjs");function u(t){return t?t.replace(/\s+/g," ").trim():null}async function i(t,e,l,s){const n=e.options?.maxFeeds||0;if(!t.href)return!1;const o=new URL(t.href,e.site).href;if(s.has(o))return!1;e.emit("log",{module:"metalinks"});try{const r=await f.checkFeed(o,"",e);if(r&&(l.push({url:o,title:u(t.title),type:r.type,feedTitle:r.title}),s.add(o),n>0&&l.length>=n))return e.emit("log",{module:"metalinks",message:`Stopped due to reaching maximum feeds limit: ${l.length} feeds found (max ${n} allowed).`}),!0}catch(r){e.options?.showErrors&&e.emit("error",{module:"metalinks",error:r.message,explanation:"An error occurred while trying to fetch and validate a feed URL found in a meta link tag. This could be due to network issues, server problems, or invalid feed content.",suggestion:"Check if the meta link URL is accessible and returns valid feed content. The search will continue with other meta links."})}return!1}async function d(t){t.emit("start",{module:"metalinks",niceName:"Meta links"});const e=[],l=new Set,n=["feed+json","rss+xml","atom+xml","xml","rdf+xml"].map(r=>`link[type="application/${r}"]`).join(", ");for(const r of t.document.querySelectorAll(n))if(await i(r,t,e,l))return e;const o='link[rel="alternate"][type*="rss"], link[rel="alternate"][type*="xml"], link[rel="alternate"][type*="atom"], link[rel="alternate"][type*="json"]';for(const r of t.document.querySelectorAll(o))if(await i(r,t,e,l))return e;for(const r of t.document.querySelectorAll('link[rel="alternate"]')){const a=["/rss","/feed","/atom",".rss",".atom",".xml",".json"];if(r.href&&a.some(m=>r.href.toLowerCase().includes(m))&&await i(r,t,e,l))return e}return t.emit("end",{module:"metalinks",feeds:e}),e}module.exports=d;
